// ========================================
// CONFIGURAÇÃO DO PRISMA
// ========================================
generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

// Status da assinatura do usuário
enum SubscriptionStatus {
  ACTIVE    // Assinatura ativa
  CANCELED  // Cancelada pelo usuário
  EXPIRED   // Expirada por falta de pagamento
  PENDING   // Aguardando confirmação de pagamento
}

// Planos disponíveis (100% pagos)
enum PlanType {
  BASE     // Plano base (pago padrão)
  PREMIUM  // Plano premium (pago avançado)
}

// Canais de notificação
enum NotificationChannel {
  TELEGRAM  // Telegram (prioridade inicial)
  WHATSAPP  // WhatsApp (implementação futura)
  EMAIL     // Email (notificações secundárias)
}

// Status do alerta enviado
enum AlertStatus {
  PENDING   // Aguardando envio
  SENT      // Enviado com sucesso
  FAILED    // Falha no envio
  QUEUED    // Na fila de envio
}

// Status do produto viral
enum ProductStatus {
  MONITORING  // Em monitoramento
  VIRAL       // Detectado como viral
  DECLINED    // Tendência em declínio
  INACTIVE    // Não está mais ativo
}

// Gateway de pagamento
enum PaymentGateway {
  STRIPE  // Stripe (internacional)
  ASAAS   // Asaas (brasileiro)
}

// ========================================
// MODELS
// ========================================

// Usuário do sistema
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String   // Hash bcrypt
  
  // Controle de acesso
  isActive  Boolean  @default(true)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  subscription       Subscription?
  notificationConfig NotificationConfig?
  alerts             Alert[]
  niches             Niche[]  // Nichos de interesse do usuário
  
  @@map("users")
}

// Assinatura e planos
model Subscription {
  id     String   @id @default(uuid())
  userId String   @unique
  
  // Plano atual (100% pago)
  planType PlanType           @default(BASE)
  status   SubscriptionStatus @default(PENDING)
  
  // Integração com gateway de pagamento
  paymentGateway    PaymentGateway?
  stripeCustomerId  String?         @unique  // ID do cliente no Stripe
  asaasCustomerId   String?         @unique  // ID do cliente no Asaas
  subscriptionId    String?         @unique  // ID da assinatura no gateway
  
  // Datas importantes
  trialEndsAt   DateTime?  // Fim do período de teste (se houver)
  currentPeriodStart DateTime?  // Início do período atual
  currentPeriodEnd   DateTime?  // Fim do período atual (renovação)
  canceledAt    DateTime?  // Data do cancelamento
  
  // Limites do plano
  maxAlertsPerDay   Int @default(10)  // Limite de alertas por dia (BASE: 10, PREMIUM: ilimitado)
  maxNiches         Int @default(3)   // Limite de nichos monitorados (BASE: 3, PREMIUM: ilimitado)
  canAccessPremium  Boolean @default(false)  // Acesso a features premium
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
}

// Configuração de notificações do usuário
model NotificationConfig {
  id     String @id @default(uuid())
  userId String @unique
  
  // Canais ativos
  telegramEnabled Boolean @default(false)
  whatsappEnabled Boolean @default(false)
  emailEnabled    Boolean @default(true)
  
  // Dados de contato
  telegramChatId String?  // Chat ID do Telegram
  whatsappNumber String?  // Número do WhatsApp (formato internacional)
  
  // Preferências de alerta
  minViralScore      Float @default(70.0)  // Score mínimo para enviar alerta (0-100)
  alertFrequency     Int   @default(4)     // Frequência de alertas (horas)
  onlyNewProducts    Boolean @default(false)  // Apenas produtos novos
  includeMetrics     Boolean @default(true)   // Incluir métricas no alerta
  
  // Horários de notificação
  quietHoursStart Int?  // Hora de início do modo silencioso (0-23)
  quietHoursEnd   Int?  // Hora de fim do modo silencioso (0-23)
  timezone        String @default("America/Sao_Paulo")  // Timezone do usuário
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notification_configs")
}

// Nichos/categorias de produtos
model Niche {
  id          String  @id @default(uuid())
  name        String  @unique  // Ex: "Beleza e Cuidados", "Tech Gadgets"
  slug        String  @unique  // Ex: "beleza-e-cuidados", "tech-gadgets"
  description String?
  
  // Controle
  isActive    Boolean @default(true)
  isPremium   Boolean @default(false)  // Nicho exclusivo para premium
  
  // Estatísticas
  productCount Int @default(0)  // Quantidade de produtos neste nicho
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  users    User[]     // Usuários interessados neste nicho
  products Product[]  // Produtos deste nicho
  trends   Trend[]    // Tendências deste nicho
  
  @@map("niches")
}

// Produtos virais do TikTok Shop
model Product {
  id          String @id @default(uuid())
  nicheId     String
  
  // Dados do produto
  tiktokId    String  @unique  // ID do produto no TikTok Shop
  name        String
  description String?
  price       Float
  currency    String  @default("BRL")
  
  // Links
  productUrl  String   // URL do produto no TikTok Shop
  imageUrl    String?  // Imagem principal
  videoUrl    String?  // Vídeo viral associado
  
  // Métricas atuais
  views       BigInt @default(0)
  likes       BigInt @default(0)
  comments    BigInt @default(0)
  shares      BigInt @default(0)
  sales       Int    @default(0)     // Vendas estimadas
  viralScore  Float  @default(0.0)   // Score de viralização (0-100)
  
  // Status
  status         ProductStatus @default(MONITORING)
  firstDetected  DateTime      @default(now())  // Quando foi detectado
  lastUpdated    DateTime      @updatedAt        // Última atualização de métricas
  
  // Controle
  isActive    Boolean @default(true)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  niche   Niche   @relation(fields: [nicheId], references: [id])
  alerts  Alert[]
  trends  Trend[]
  
  @@index([nicheId])
  @@index([viralScore])
  @@index([status])
  @@map("products")
}

// Alertas enviados aos usuários
model Alert {
  id        String @id @default(uuid())
  userId    String
  productId String
  
  // Dados do alerta
  channel      NotificationChannel
  status       AlertStatus         @default(PENDING)
  message      String              // Conteúdo do alerta
  
  // Métricas do produto no momento do alerta
  productViralScore Float
  productViews      BigInt
  productSales      Int
  
  // Controle de envio
  sentAt       DateTime?  // Quando foi enviado
  failedReason String?    // Motivo da falha (se houver)
  retryCount   Int @default(0)  // Tentativas de reenvio
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("alerts")
}

// Histórico de tendências e métricas
model Trend {
  id        String @id @default(uuid())
  productId String
  nicheId   String
  
  // Snapshot das métricas
  views      BigInt
  likes      BigInt
  comments   BigInt
  shares     BigInt
  sales      Int
  viralScore Float
  
  // Variação desde última análise
  viewsGrowth  Float  @default(0.0)  // Crescimento em %
  likesGrowth  Float  @default(0.0)
  salesGrowth  Float  @default(0.0)
  scoreGrowth  Float  @default(0.0)
  
  // Timestamp do snapshot
  recordedAt DateTime @default(now())
  
  // Relacionamentos
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  niche   Niche   @relation(fields: [nicheId], references: [id])
  
  @@index([productId])
  @@index([recordedAt])
  @@map("trends")
}
